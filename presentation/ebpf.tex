\documentclass[aspectratio=169]{beamer}

\usepackage[T1]{fontenc}
\usepackage[english]{babel}
\usepackage{dirtytalk}
\usepackage{pgfpages}
\usepackage{listings}
\usepackage{linehighlight}
\usepackage{color}
\usepackage{xparse}
\usepackage{xfp}

\usepackage{blindtext}
\usepackage{lipsum}

\title{Introduction to eBPF}
\author{Martin Ertsås\\ \texttt{martiert@gmail.com}}
\date{\today}

\usetheme{ciscolysaker}
\setbeameroption{show notes on second screen=right}

\definecolor{codehighlight}{rgb}{0.8, 0.95, 0.8}
\definecolor{codebackground}{rgb}{0.9, 0.9, 0.9}


\usepackage{graphicx}

\lstdefinelanguage{diff}{
 morecomment=[f][\color{Green}]{+},
 morecomment=[f][\color{Red}]{-},
}

\lstdefinelanguage{asm}{
  morekeywords={load, jmp, jeq, jge, jgt, ret},
}
\lstdefinestyle{cpp}{
  language=C++,
  morekeywords={
    __u32,
    __u64,
    __s32,
    __s64,
    uint8_t,
    uint16_t,
    uint32_t,
    uint64_t,
    int8_t,
    int16_t,
    int32_t,
    int64_t,
  },
}

\lstset{
 frame=single,
 language=diff,
 morekeywords={uint8_t, ssize_t},
 keywordstyle=\color{Blue},
 showspaces=false,
 showstringspaces=false,
 backgroundcolor=\color{codebackground},
 literate={å}{{\aa}}1
}
\newenvironment{SplitView}[2]
  {
    \begin{columns}
      \begin{column}{0.35\textwidth}
        \centering
        \includegraphics[width=\textwidth, keepaspectratio]{#1}
      \end{column}
      \begin{column}{0.65\textwidth}
        {\Large\color{Blue}{#2}}
        \vskip 1em
  }
  {
      \end{column}
    \end{columns}
  }
\newcommand{\demo}[1]{\begin{frame}{DEMO!}\note{#1}\end{frame}}

\begin{document}

\begin{frame}
  \titlepage

  \note{
    \begin{itemize}
      \item Ask questions whenever
      \item Feel free to interrupt
      \item If I forget breaks, shout out
    \end{itemize}
  }
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{\$ Whoami}
    \centering
    \lstinputlisting[basicstyle=\small]{examples/whoami.txt}
  \end{SplitView}

  \note{
    \begin{itemize}
      \item Works for Cisco Norway
      \item Been working a couple years now with integrating chromium in our embedded devices
      \item Mainly interested in systems programming, security, and training
      \item Likes board games, RPG games, and cycling
    \end{itemize}
  }
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{I have no idea what I'm doing}
    \begin{itemize}
      \item<2-> I wanted to experiment with eBPF
      \item<2-> So I submitted this talk
      \item<2-> This might have been a mistake
      \item<2-> Definitely do not use any code from this presentation
      \item<2-> It will blow up in your face
    \end{itemize}
  \end{SplitView}

  \note{
  }
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{What is eBPF?}
    \begin{itemize}
      \item A way to program the kernel without building a new kernel or writing kernel modules
      \item A programing language, evaluated by the kernel
      \item Event driven programs, running when the kernel passes a pre-defined hook
      \item Can be controlled from userspace
    \end{itemize}
  \end{SplitView}

  \note{
    Write kernel features without:

    \begin{itemize}
      \item Modifying the kernel
      \item Submit the patch upstream
      \item Wait for kernel release
      \item Wait for distro to pick up the new kernel
    \end{itemize}
  }
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{Can I harm the kernel?}
    \begin{itemize}
      \item Runs through a verifyer on every program load
      \item Process loading the eBPF program needs correct capabilities
      \item The program does not crash or harm the system
      \item The program runs to completion
    \end{itemize}
  \end{SplitView}

  \note{
  }
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{Why would you like to use this?}
    \begin{itemize}
      \item Monitoring and tracing of processes
      \item Network monitoring
      \item Making network decisions
      \item To be one of the cool kids
    \end{itemize}
  \end{SplitView}

  \note{
    Our use case was to put a specific process into a cgroup on creation, to limit its memory usage
  }
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{Abstractions and tools}
    \begin{itemize}
      \item libbpf
      \item bpftool
      \item bcc
      \item clang
    \end{itemize}
  \end{SplitView}

  \note{
  }
\end{frame}

\begin{frame}{Simple ebpf program}
  \lstinputlisting[basicstyle=\small, language=C]{examples/simple.ebpf.c}

  \note{
    \begin{itemize}
      \item $SEC$ defines an ELF section to use
      \item A GPL compatible license is required
      \item $BPF_CORE_READ$ reads entries from a struct
      \item bpf\_probe\_read\_kernel\_str copies from an unsafe kernel address
    \end{itemize}
  }
\end{frame}

\begin{frame}{Simple loading program}
  \lstinputlisting[language=C]{examples/simple.host.c}

  \note{
    The simple\_\_ functions are auto generated from the ebp program using bpftool
  }
\end{frame}

\demo{
  \begin{itemize}
    \item bpftool prog to show that it is loaded
    \item cat /sys/kernel/debug/tracing/trace\_pipe
  \end{itemize}
}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{Communicate to userspace}
    \begin{itemize}
      \item .bss section
      \item ebpf maps
    \end{itemize}
  \end{SplitView}
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{ebpf modification}
    \lstinputlisting{examples/bss.diff}
  \end{SplitView}
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{userspace modification}
    \lstinputlisting{examples/bss.host.diff}
  \end{SplitView}

  \note{
    \begin{itemize}
      \item Adding an integer to the .bss section
      \item Using that from the ebpf program
      \item Exposed in the skeleton on the host side
      \item Pretty much one-way
      \item Very limited
    \end{itemize}
  }
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{ebpf maps}
    \begin{itemize}
      \item Multiple map types
    \end{itemize}
  \end{SplitView}
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{Creating a map}
    \lstinputlisting{examples/ringbuffer.define.diff}
  \end{SplitView}
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{Creating a map}
    \lstinputlisting{examples/ringbuffer.bpf.diff}
  \end{SplitView}
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{Reading a ringbuffer from ebpf}
    \lstinputlisting{examples/ringbuffer.userspace.diff}
  \end{SplitView}
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{Consuming data}
    \lstinputlisting[language=C]{examples/ringbuffer.callback.cpp}
  \end{SplitView}
\end{frame}

\demo{}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{Communicating from userspace}
    \begin{itemize}
      \item Very similar to communicating to userspace
      \item Can send over more complex types
      \item Can easily keep several entries
    \end{itemize}
  \end{SplitView}
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{Path of commands map}
    \lstinputlisting{examples/command\_name.ebpf.diff}
  \end{SplitView}
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{Using the commands map}
    \lstinputlisting{examples/command\_name.ebpf.check.diff}
  \end{SplitView}
\end{frame}

\begin{frame}
  \begin{SplitView}{images/mertsas.jpg}{Populating from userspace}
    \lstinputlisting{examples/command\_name.userspace.diff}
  \end{SplitView}
\end{frame}

\demo{}

% Internal communication between exec and exit

% Connect a network ebpf program to a cgroup

\begin{frame}
  \begin{SplitView}{images/Wictor.jpg}{Thank you}
  \end{SplitView}
\end{frame}

\end{document}
